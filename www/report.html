<ons-page>
  <ons-toolbar>
    <div class="center survey-title"></div>
  </ons-toolbar>
  <div class="segment-area">
    <ons-segment id="segment" style="width: 180px">
      <button>表示</button>
      <button>レポート</button>
    </ons-segment>
  </div>
  <ons-list>

  </ons-list>
  <script>
    (() => {
      // 画面表示時の処理
      ons.getScriptPage().onShow = async function() {
        // アンケート内容の画面表示
        showSurvey.bind(this)();
        // セグメントの切り替え
        this.querySelector('#segment').setActiveButton(1);
        // アンケート結果の表示
        showAnswers.bind(this)();
      }

      // 画面初期化時の処理
      ons.getScriptPage().onInit = async function() {
        // セグメントを切り替える処理
        this.querySelectorAll('#segment button').forEach((d, i) => {
          d.onclick = () => changeView.bind(this)(i);
        });
      }

      // 表示を切り替える（ons-navigatorを前の画面に戻す）
      function changeView(index) {
        if (index === 0) {
          document.querySelector('#nav').popPage();
        }
      }

      // アンケート結果の表示処理
      async function showAnswers() {
        // アンケート結果の取得
        const answers = await getAnswers(this.data.survey);
        // アンケート結果をサマライズ
        const results = summaryAnswers(answers);
        // HTMLの組み立て
        const html = [];
        for (const key in results) {
          html.push(`<ons-list-header>${key}</ons-list-header>`);
          for (const value in results[key]) {
            const num = results[key][value];
            html.push('<ons-list-item>');
            html.push(`<div class="center">${value}</div>`);
            html.push(`<div class="right">${num}</div>`);
            html.push('</ons-list-item>');
          }
        }
        // HTMLの反映
        this.querySelector('ons-list').innerHTML = html.join('');
      }

      // アンケート結果のサマライズ
      function summaryAnswers(answers) {
        const results = {};
        answers.forEach(answer => {
          for (const key in answer) {
            const value = answer[key];
            // NCMBから取得される不要なデータを除外
            if (['function', 'object'].indexOf(typeof value) > -1) continue;
            if (['acl', 'createDate', 'objectId', 'survey', 'survey_id', 'updateDate', 'className'].indexOf(key) > -1) continue;
            // 結果をアンケート項目ごと、値ごとに集計
            if (!results[key]) {
              results[key] = {};
            }
            if (!results[key][value]) {
              results[key][value] = 0;
            }
            results[key][value]++;
          }
        });
        // 結果を返却
        return results;
      }

      // アンケート結果をNCMBから取得
      async function getAnswers(survey) {
        return ncmb.DataStore('Answer')
          .equalTo('survey', {
            __type: 'Pointer',
            className: 'Survey',
            objectId: survey.objectId
          })
          .limit(1000)
          .fetchAll();
      }
    })();
  </script>
  <style>
    .segrament-area {
      text-align: center;
    }
  </style>
</ons-page>